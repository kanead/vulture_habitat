#' clean the Darcy Ogada data and Extract a file for each bird

rm(list=ls())

setwd("C:\\Users\\Adam Kane\\Documents\\Manuscripts\\VultureMovementData\\VultureMovementData")

library(readxl)
library(tidyverse)

# read_excel reads both xls and xlsx files
tempdata<- read_csv("northern Kenya vulture project.csv")
head(tempdata)
names(tempdata)

#' rename those confusing column names that have hyphens 
names(tempdata)[names(tempdata) == 'location-long'] <- 'long'
names(tempdata)[names(tempdata) == 'location-lat'] <- 'lat'
names(tempdata)[names(tempdata) == 'individual-local-identifier'] <- 'id'
names(tempdata)[names(tempdata) == 'individual-taxon-canonical-name'] <- 'species'
names(tempdata)[names(tempdata) == 'timestamp'] <- 'time'

#' exclude non GPS sensor types
#' the column header has a hyphen which is a problem with R so I call the column by
#' number directly
tempdata <- filter(tempdata,tempdata[,36]=="gps")

#' select only those columns 
mydata <- select(tempdata,time,long,lat,id,species)
mydata

#' simplify the names of the ids 
#' this extracts everything before the first space
mydata$id<-gsub(" .*$", "",mydata$id)
#' this removes extracts everything up to the first apostrophe
mydata$id <- gsub("(.+?)(\\'.*)", "\\1", mydata$id) 

#' rename awkward id names that have hyphens etc.
mydata$id <- as.factor(mydata$id)
mydata <- mutate(mydata, id = fct_recode(id, "ThreeInOne" = "Three-in-one"))
mydata <- mutate(mydata, id = fct_recode(id, "TwoToe" = "Two"))
levels(factor(mydata$id))

#' make species a factor level
mydata$species<-as.factor(mydata$species)
levels(mydata$species)

#' rename the species to something simpler 
mydata<-mutate(mydata, species = fct_recode(species, "wb" = "Gyps africanus"))
mydata<-mutate(mydata, species = fct_recode(species, "rv" = "Gyps rueppellii"))
mydata<-mutate(mydata, species = fct_recode(species, "rv" = "Gyps")) # Dutch 
mydata<-mutate(mydata, species = fct_recode(species, "hv" = "Necrosyrtes monachus"))
levels(mydata$species)

#' add a column name for the study
mydata$study <- "north"

#' add a column name for the timezone
mydata$gmt <- "q"

#' want columns in this order: time long lat id	species	study	gmt
head(mydata)

#' dates are getting messed up in the export
#' specify their format here
mydata$time <- format(mydata$time, "%d/%m/%Y %H:%M:%S")
head(mydata)

#' group by the id column and export a csv for each
customFun  = function(DF) {
  write.csv(DF,paste0("",unique(DF$id),".csv"),row.names = FALSE)
  return(DF)
}

mydata %>% 
  group_by(id) %>% 
  do(customFun(.))
